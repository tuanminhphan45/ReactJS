'use strict';var _0x870c8e=_0x573c;(function(_0xbff154,_0x2501a5){var _0x47ff11=_0x573c,_0x232ad4=_0xbff154();while(!![]){try{var _0x55733b=parseInt(_0x47ff11(0x233))/0x1*(parseInt(_0x47ff11(0x22f))/0x2)+parseInt(_0x47ff11(0x234))/0x3*(parseInt(_0x47ff11(0x225))/0x4)+parseInt(_0x47ff11(0x237))/0x5*(-parseInt(_0x47ff11(0x228))/0x6)+parseInt(_0x47ff11(0x204))/0x7+-parseInt(_0x47ff11(0x203))/0x8+parseInt(_0x47ff11(0x1fc))/0x9+-parseInt(_0x47ff11(0x239))/0xa;if(_0x55733b===_0x2501a5)break;else _0x232ad4['push'](_0x232ad4['shift']());}catch(_0x2ea9a3){_0x232ad4['push'](_0x232ad4['shift']());}}}(_0x4a11,0xeab18));function _0x4a11(){var _0x55ce00=['design:returntype','sub','phone','function','design:paramtypes','QDYIc','c21f969b5f03d33d43e04f8f136e7682.png','password','configService','getOwnPropertyDescriptor','prototype','validateUser','metadata','11608254ysFDVb','Req','verify','length','compareSync','Hết\x20hạn\x20refresh_token.\x20Please\x20do\x20login\x20again.','Res','2606664DimPiz','11219516jCfmiv','email','__esModule','clearCookie','handleRefreshToken','findByUsername','bcryptjs','get','UserService','__param','object','JwtService','defineProperty','JWT_REFRESH_EXPIRE_IN','jwtService','role','sign','findUserByToken','default','avatar','@nestjs/common','fullName','cookie','cookies','login','CgNhr','createRefreshToken','Không\x20tồn\x20tại\x20refresh_token\x20ở\x20cookies.\x20Please\x20do\x20login\x20again.','KnpZs','findOneByUsernameSocialMedia','decorate','updateUserToken','handleSocialMediaToken','212756AZQvKd','fetchAccount','AuthService','494154TUWczA','Injectable','__importDefault','BadRequestException','__decorate','__metadata','_id','4rbsHWQ','JWT_REFRESH_SECRET','design:type','ConfigService','414733qJlNEA','42qEcyfr','@nestjs/jwt','userService','25Xulsfb','refresh_token','27677740aqQboe','handleUserLogout'];_0x4a11=function(){return _0x55ce00;};return _0x4a11();}function _0x573c(_0x29bbb0,_0x27e1a6){var _0x4a1114=_0x4a11();return _0x573c=function(_0x573c5a,_0x3778a1){_0x573c5a=_0x573c5a-0x1ef;var _0x576609=_0x4a1114[_0x573c5a];return _0x576609;},_0x573c(_0x29bbb0,_0x27e1a6);}var __decorate=this&&this[_0x870c8e(0x22c)]||function(_0x382821,_0x9fb1e6,_0x2f58af,_0x18d990){var _0x1cbd85=_0x870c8e,_0x412cd7,_0x133c8f=arguments['length'],_0x3e3807=_0x133c8f<0x3?_0x9fb1e6:null===_0x18d990?_0x18d990=Object[_0x1cbd85(0x1f8)](_0x9fb1e6,_0x2f58af):_0x18d990;if(_0x1cbd85(0x20e)==typeof Reflect&&_0x1cbd85(0x1f2)==typeof Reflect[_0x1cbd85(0x222)])_0x3e3807=Reflect[_0x1cbd85(0x222)](_0x382821,_0x9fb1e6,_0x2f58af,_0x18d990);else{for(var _0x380703=_0x382821[_0x1cbd85(0x1ff)]-0x1;0x0<=_0x380703;_0x380703--)(_0x412cd7=_0x382821[_0x380703])&&(_0x3e3807=(_0x133c8f<0x3?_0x412cd7(_0x3e3807):0x3<_0x133c8f?_0x412cd7(_0x9fb1e6,_0x2f58af,_0x3e3807):_0x412cd7(_0x9fb1e6,_0x2f58af))||_0x3e3807);}return 0x3<_0x133c8f&&_0x3e3807&&Object[_0x1cbd85(0x210)](_0x9fb1e6,_0x2f58af,_0x3e3807),_0x3e3807;},__metadata=this&&this[_0x870c8e(0x22d)]||function(_0x57b0ba,_0x1a4c3d){var _0x1d9ca0=_0x870c8e;if(_0x1d9ca0(0x20e)==typeof Reflect&&'function'==typeof Reflect['metadata'])return Reflect[_0x1d9ca0(0x1fb)](_0x57b0ba,_0x1a4c3d);},__param=this&&this[_0x870c8e(0x20d)]||function(_0x4a5816,_0x593eb4){return function(_0xa45f65,_0x3a138b){var _0x241f8d=_0x573c;if(_0x241f8d(0x220)===_0x241f8d(0x1f4))return _0x5ab2af&&_0x41aac7[_0x241f8d(0x206)]?_0x421a80:{'default':_0x1f80af};else _0x593eb4(_0xa45f65,_0x3a138b,_0x4a5816);};},__importDefault=this&&this[_0x870c8e(0x22a)]||function(_0x3437bf){return _0x3437bf&&_0x3437bf['__esModule']?_0x3437bf:{'default':_0x3437bf};};Object[_0x870c8e(0x210)](exports,'__esModule',{'value':!0x0}),exports[_0x870c8e(0x227)]=void 0x0;const common_1=require(_0x870c8e(0x218)),user_service_1=require('../user/user.service'),jwt_1=require(_0x870c8e(0x235)),ms_1=__importDefault(require('ms')),config_1=require('@nestjs/config'),bcrypt=require(_0x870c8e(0x20a));let AuthService=class{constructor(_0x3d1195,_0x20076a,_0x160fb3){var _0x47af98=_0x870c8e;this['userService']=_0x3d1195,this[_0x47af98(0x212)]=_0x20076a,this[_0x47af98(0x1f7)]=_0x160fb3;}async[_0x870c8e(0x1fa)](_0xec1fb9,_0x58dd02){var _0x58e0f4=_0x870c8e;_0xec1fb9=await this[_0x58e0f4(0x236)][_0x58e0f4(0x209)](_0xec1fb9);if(_0xec1fb9&&bcrypt[_0x58e0f4(0x200)](_0x58dd02,_0xec1fb9['password']))return _0xec1fb9[_0x58e0f4(0x1f6)]=void 0x0,_0xec1fb9;throw new common_1[(_0x58e0f4(0x22b))]('Thông\x20tin\x20đăng\x20nhập\x20không\x20chính\x20xác');}async[_0x870c8e(0x21c)](_0x3534aa,_0x3aeb26,_0x2e93e3){var _0x1f4a74=_0x870c8e,_0xdd7f4c={'email':_0x3534aa[_0x1f4a74(0x205)],'phone':_0x3534aa[_0x1f4a74(0x1f1)],'fullName':_0x3534aa[_0x1f4a74(0x219)],'role':_0x3534aa[_0x1f4a74(0x213)],'sub':_0x3534aa['_id'],'avatar':_0x3534aa&&_0x3534aa[_0x1f4a74(0x217)]?_0x3534aa[_0x1f4a74(0x217)]:_0x1f4a74(0x1f5)},_0x2a6e67=this[_0x1f4a74(0x21e)](_0xdd7f4c);return await this[_0x1f4a74(0x236)][_0x1f4a74(0x223)](_0x3534aa[_0x1f4a74(0x22e)],_0x2a6e67),_0x3aeb26[_0x1f4a74(0x21a)]('refresh_token',_0x2a6e67,{'maxAge':(0x0,ms_1[_0x1f4a74(0x216)])(this['configService'][_0x1f4a74(0x20b)](_0x1f4a74(0x211))),'httpOnly':!0x0}),{'access_token':this[_0x1f4a74(0x212)][_0x1f4a74(0x214)](_0xdd7f4c),'user':{'email':_0x3534aa[_0x1f4a74(0x205)],'phone':_0x3534aa[_0x1f4a74(0x1f1)],'fullName':_0x3534aa[_0x1f4a74(0x219)],'role':_0x3534aa[_0x1f4a74(0x213)],'avatar':_0x3534aa[_0x1f4a74(0x217)],'id':_0x3534aa[_0x1f4a74(0x22e)]}};}[_0x870c8e(0x21e)](_0xcdcbef){var _0x1ccc68=_0x870c8e;return this[_0x1ccc68(0x212)]['sign'](_0xcdcbef,{'secret':this[_0x1ccc68(0x1f7)][_0x1ccc68(0x20b)](_0x1ccc68(0x230)),'expiresIn':this[_0x1ccc68(0x1f7)][_0x1ccc68(0x20b)]('JWT_REFRESH_EXPIRE_IN')});}async[_0x870c8e(0x226)](_0xf960e4){var {_id:_0xf960e4,phone:_0x241bb4,email:_0x260081,fullName:_0x4098ff,role:_0x150700,avatar:_0x5a1873}=_0xf960e4;return{'user':{'id':_0xf960e4,'email':_0x260081,'phone':_0x241bb4,'fullName':_0x4098ff,'role':_0x150700,'avatar':_0x5a1873}};}async['logout'](_0x3ecb97,_0x73061f){var _0x396976=_0x870c8e;return _0x73061f[_0x396976(0x207)](_0x396976(0x238)),await this[_0x396976(0x236)][_0x396976(0x23a)](_0x3ecb97),'Logout\x20success.';}async[_0x870c8e(0x208)](_0x419075,_0x588180){var _0x1fd23b=_0x870c8e;if(null==(_0x18f687=_0x419075[_0x1fd23b(0x21b)])||!_0x18f687[_0x1fd23b(0x238)])throw new common_1[(_0x1fd23b(0x22b))](_0x1fd23b(0x21f));const _0x4c3710=_0x419075['cookies'][_0x1fd23b(0x238)];var _0x18f687=await this['userService'][_0x1fd23b(0x215)](_0x4c3710);if(!_0x18f687)throw new common_1[(_0x1fd23b(0x22b))]('Không\x20tồn\x20tại\x20refresh_token\x20ở\x20database.\x20Please\x20do\x20login\x20again.');try{var _0x34ad44=this['jwtService'][_0x1fd23b(0x1fe)](_0x4c3710,{'secret':this['configService'][_0x1fd23b(0x20b)](_0x1fd23b(0x230))});if(_0x34ad44){if(_0x1fd23b(0x21d)===_0x1fd23b(0x21d)){var _0x8e3da1={'email':_0x34ad44[_0x1fd23b(0x205)],'phone':_0x18f687[_0x1fd23b(0x1f1)],'fullName':_0x18f687[_0x1fd23b(0x219)],'role':_0x34ad44[_0x1fd23b(0x213)],'sub':_0x34ad44[_0x1fd23b(0x1f0)],'avatar':_0x18f687&&_0x18f687['avatar']?_0x18f687[_0x1fd23b(0x217)]:_0x1fd23b(0x1f5)};const _0x502c20=this[_0x1fd23b(0x21e)](_0x8e3da1);return await this['userService']['updateUserToken'](_0x34ad44[_0x1fd23b(0x1f0)],_0x502c20),_0x588180['cookie']('refresh_token',_0x502c20,{'maxAge':(0x0,ms_1[_0x1fd23b(0x216)])(this[_0x1fd23b(0x1f7)]['get']('JWT_REFRESH_EXPIRE_IN')),'httpOnly':!0x0}),{'access_token':this[_0x1fd23b(0x212)][_0x1fd23b(0x214)](_0x8e3da1),'user':{'email':_0x34ad44[_0x1fd23b(0x205)],'phone':_0x34ad44[_0x1fd23b(0x1f1)],'fullName':_0x34ad44[_0x1fd23b(0x219)],'role':_0x34ad44[_0x1fd23b(0x213)],'avatar':_0x34ad44[_0x1fd23b(0x217)],'id':_0x34ad44[_0x1fd23b(0x1f0)]}};}else return this[_0x1fd23b(0x212)][_0x1fd23b(0x214)](_0x4c6978,{'secret':this[_0x1fd23b(0x1f7)][_0x1fd23b(0x20b)](_0x1fd23b(0x230)),'expiresIn':this['configService'][_0x1fd23b(0x20b)](_0x1fd23b(0x211))});}}catch(_0xba2497){throw _0x588180['clearCookie'](_0x1fd23b(0x238)),new common_1[(_0x1fd23b(0x22b))](_0x1fd23b(0x201));}}async['handleSocialMediaToken'](_0x26d130,_0x528669,_0x185748){var _0x1ed7ce=_0x870c8e;let _0x525614;var {_id:_0x528669,email:_0x26d130,avatar:_0x3f3dba,phone:_0x5f31b8,fullName:_0x22a44e,role:_0x2f84d6}=(_0x525614=(_0x525614=await this[_0x1ed7ce(0x236)][_0x1ed7ce(0x221)](_0x528669,_0x26d130))||await this['userService']['createAccountForSocialMedia'](_0x528669,_0x26d130))['toObject'](),_0x176c7b={'email':_0x26d130,'phone':_0x5f31b8,'fullName':_0x22a44e,'role':_0x2f84d6,'avatar':_0x3f3dba,'sub':_0x528669},_0x3fa348=this['createRefreshToken'](_0x176c7b);return await this['userService']['updateUserToken'](_0x528669,_0x3fa348),_0x185748[_0x1ed7ce(0x21a)](_0x1ed7ce(0x238),_0x3fa348,{'maxAge':(0x0,ms_1[_0x1ed7ce(0x216)])(this[_0x1ed7ce(0x1f7)][_0x1ed7ce(0x20b)](_0x1ed7ce(0x211))),'httpOnly':!0x0}),{'access_token':this[_0x1ed7ce(0x212)][_0x1ed7ce(0x214)](_0x176c7b),'user':{'email':_0x26d130,'phone':_0x5f31b8,'fullName':_0x22a44e,'role':_0x2f84d6,'avatar':_0x3f3dba,'id':_0x528669}};}};exports[_0x870c8e(0x227)]=AuthService,__decorate([__param(0x1,(0x0,common_1[_0x870c8e(0x202)])({'passthrough':!0x0})),__param(0x2,(0x0,common_1[_0x870c8e(0x1fd)])()),__metadata(_0x870c8e(0x231),Function),__metadata(_0x870c8e(0x1f3),[Object,Object,Object]),__metadata(_0x870c8e(0x1ef),Promise)],AuthService[_0x870c8e(0x1f9)],_0x870c8e(0x21c),null),__decorate([__param(0x1,(0x0,common_1[_0x870c8e(0x202)])({'passthrough':!0x0})),__metadata(_0x870c8e(0x231),Function),__metadata('design:paramtypes',[String,Object]),__metadata(_0x870c8e(0x1ef),Promise)],AuthService['prototype'],'logout',null),__decorate([__param(0x1,(0x0,common_1[_0x870c8e(0x202)])({'passthrough':!0x0})),__metadata(_0x870c8e(0x231),Function),__metadata(_0x870c8e(0x1f3),[Object,Object]),__metadata(_0x870c8e(0x1ef),Promise)],AuthService[_0x870c8e(0x1f9)],_0x870c8e(0x208),null),__decorate([__param(0x2,(0x0,common_1[_0x870c8e(0x202)])({'passthrough':!0x0})),__metadata(_0x870c8e(0x231),Function),__metadata(_0x870c8e(0x1f3),[String,String,Object]),__metadata('design:returntype',Promise)],AuthService[_0x870c8e(0x1f9)],_0x870c8e(0x224),null),exports[_0x870c8e(0x227)]=AuthService=__decorate([(0x0,common_1[_0x870c8e(0x229)])(),__metadata('design:paramtypes',[user_service_1[_0x870c8e(0x20c)],jwt_1[_0x870c8e(0x20f)],config_1[_0x870c8e(0x232)]])],AuthService);